<html>
<head>
<script src ="js/instruments.js"> </script>
<script src ="js/image_index.js"> </script>
<script>

function update()
{
	var l_td   = document.getElementById("L_td");
	var r_td   = document.getElementById("R_td");
	var l_img  = document.getElementById("L_img");
	var r_img  = document.getElementById("R_img");
	var sol    = document.getElementById("sol").value;
	var instrument = document.getElementById("instrument").value;
	var image_num = document.getElementById("image_num").value;
	var invert = document.getElementById("invert");
	
  // We assume sol and number have been validated at this point
  
	// Form URLs
	var l_url = image_index[sol][instrument][image_num]["l_file_path"];
	var r_url = image_index[sol][instrument][image_num]["r_file_path"];
	if(invert.checked)
	{
    temp = r_url
    r_url = l_url
    l_url = temp
	}
	
	// Fetch and determine the img aspect ratio
	// Assume both are of equal size
	var l_preload_image = new Image();
	var r_preload_image = new Image();
	l_preload_image.src = l_url; 
	r_preload_image.src = r_url; 
	var img_ratio = l_preload_image.width / l_preload_image.height;
	
	var cell_height = l_td.scrollHeight;
	var cell_width  = l_td.scrollWidth;
	var cell_ratio  = cell_width / cell_height;
	
	var img_height = l_preload_image.height;
	var img_width = l_preload_image.width;
	if(img_width > cell_width || 
    img_height > cell_height) {
    if(cell_ratio > img_ratio)
    { // height-limited
      img_height = Math.min(cell_height, l_preload_image.height);
      img_width = img_ratio * img_height;
    } 
    else 
    { // width-limited
      img_width = Math.min(cell_width, l_preload_image.width);
      img_height = cell_width / img_ratio;
    }
  }
	l_img.height = img_height;
	l_img.width  = img_width;
	r_img.height = img_height;
	r_img.width  = img_width;
	
	l_img.src =  l_url; 
	r_img.src =  r_url; 

	// cache prior and next images
	//var sel_ind = document.getElementById("suffix").selectedIndex;
	//if(sel_ind > 0)
	//{
	//	var prev_suffix = document.getElementById("suffix").options[sel_ind - 1].value;
	//	l_preload_image.src = prefix + "L" + prev_suffix;
	//	r_preload_image.src = prefix + "R" + prev_suffix;
	//}
	//if(sel_ind < document.getElementById("suffix").options.length - 1)
	//{
	//	var next_suffix = document.getElementById("suffix").options[sel_ind + 1].value;
	//	l_preload_image.src = prefix + "L" + next_suffix;
	//	r_preload_image.src = prefix + "R" + next_suffix;
	//}
}

function load_suffixes_from_array(lines, suffixes)
{
	// Remove existing suffixes
	for(i = suffixes.options.length - 1; i >= 0; --i)
	{
		suffixes.options[i] = null;
	}
	
	len = lines.length;
	for(i = 0; i < len; ++i)
	{
		var option = document.createElement("option");
		option.text = lines[i];
		option.value = lines[i];
		suffixes.add(option);
	}

}

function load_suffixes_from_html()
{
	var suffixes = document.getElementById("suffix");
	var lines_area = document.getElementById("lines");
	var lines = lines_area.value.split('\n');
	load_suffixes_from_array(lines, suffixes);
}

function preload()
{
	var prefix = document.getElementById("prefix").value;
	var suffixes = document.getElementById("suffix");
	
	var len = suffixes.options.length;
	var l_imgs = new Array(len);
	var r_imgs = new Array(len);
	for(i = 0; i < len; ++i)
	{
		var url = prefix + "L" + suffixes.options[i].value;
		l_imgs[i] = new Image();
		l_imgs[i].src = url;
		url = prefix + "R" + suffixes.options[i].value;
		r_imgs[i] = new Image();
		r_imgs[i].src = url;
	}
}

function initPage() {

  // Populate the "instrument" selector
  var inst_names = []
  var inst_dropdown = document.getElementById("instrument");
  for (var name in instruments) {
    var option = document.createElement("option");
    option.text = instruments[name]["human_readable"];
    option.value = name;
    inst_dropdown.add(option);
  }

  // Set sol to the last one
  var sol_sel = document.getElementById("sol");
  // Hackish way to get the last known sol
  var sol_last
  for (var sol_last in image_index) {
    ;
  }
  sol_sel.value = sol_last;
}

</script>
</head>
<body margin="0" padding="0" onload="initPage();">
	<table width="100%" height="100%" margin="0" padding="0" cellpadding="0"><tbody>
		<tr height="*">
			<td width="50%" id="L_td" align="center">
				<img id="L_img" width="1" height="1" src="" />
			</td>
			<td width="50%" id="R_td" align="center">
				<img id="R_img" width="1" height="1" src="" />
			</td>
		</tr>
		<tr height="50">
			<td colspan="2" align="center">
				<table style="border:1px solid black;">
					<tr>
            <td>Sol</td>
						<td>Instrument</td>
						<td>Image</td>
						<td><input type="button" value="update" onclick="update();" /></td>
					</tr>
					<tr>
						<td><input type="text" id="sol" value="1100"/></td>
						<td>
							<select id="instrument" onchange="">
							</select>
						</td>
						<td>
              <input type="text" id="image_num" value="0" size="4"/>
						</td>
						<td>
							<input type="checkbox" label="invert" id="invert" checked onchange="update();">invert</input>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</tbody></table>
</body>
</html>