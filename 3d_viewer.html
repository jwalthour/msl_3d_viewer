<html>
<head>
<script src="js/instruments.js"> </script>
<script src="js/image_index.js"> </script>
<script src="js/avail.js"> </script>
<script>

// Page state variables
var cur_sol = -1;
var cur_img = -1;

var L_IMAGE_ID = "L_img";
var R_IMAGE_ID = "R_img";

function update()
{
	var l_td   = document.getElementById("L_td");
	var r_td   = document.getElementById("R_td");
	var l_img  = document.getElementById(L_IMAGE_ID);
	var r_img  = document.getElementById(R_IMAGE_ID);
	document.getElementById("sol").value = cur_sol;
	var instrument = document.getElementById("instrument").value;
	document.getElementById("image_num").value = cur_img;
	var invert = document.getElementById("invert");
	
  // We assume sol and number have been validated at this point
  
	// Form URLs
  console.log("Updating screen to Sol " + cur_sol + " " + instrument + " image # " + cur_img);
	var l_url = image_index[cur_sol][instrument][cur_img]["l_file_path"];
	var r_url = image_index[cur_sol][instrument][cur_img]["r_file_path"];
	if(invert.checked)
	{
    temp = r_url
    r_url = l_url
    l_url = temp
	}
	
	var cell_height = l_td.scrollHeight;
	var cell_width  = l_td.scrollWidth;
	var cell_ratio  = cell_width / cell_height;
	
	// Images are all square for now
  var img_size;
	if(l_td.scrollWidth > l_td.scrollHeight)
  { // height-limited
    img_size = cell_height;
  } 
  else 
  { // width-limited
    img_size = cell_width;
  }

	l_img.height = img_size;
	l_img.width  = img_size;
	r_img.height = img_size;
	r_img.width  = img_size;
	l_img.src =  l_url;
	r_img.src =  r_url;

}

function initPage() {
  // Populate the "instrument" selector
  var inst_names = []
  var inst_dropdown = document.getElementById("instrument");
  for (var name in instruments) {
    var option = document.createElement("option");
    option.text = instruments[name]["human_readable"];
    option.value = name;
    inst_dropdown.add(option);
  }

  switchInstrument();
}

// Navigation functions - all within a particular instrument
function gotoNextImage() {
  var inst_dropdown = document.getElementById("instrument");
  var avail_imgs = image_index[cur_sol][inst_dropdown.value];
  if(++cur_img >= avail_imgs.length) { cur_img = avail_imgs.length - 1; }
  update();
}

function gotoPrevImage() {
  if(--cur_img < 0) { cur_img = 0; }
  update();
}

function gotoNextSol() {
  var inst_dropdown = document.getElementById("instrument");
  var avail_sols = avail[inst_dropdown.value];
  var i = avail_sols.indexOf(cur_sol);
  if(++i >= avail_sols.length) { i = avail_sols.length - 1; }
  else { cur_img = 0;}
  cur_sol = avail_sols[i]
  update();
}

function gotoPrevSol() {
  var inst_dropdown = document.getElementById("instrument");
  var avail_sols = avail[inst_dropdown.value]
  var i = avail_sols.indexOf(cur_sol);
  if(--i < 0) { i = 0; }
  else { cur_img = 0;}
  cur_sol = avail_sols[i]

  update();
}

function switchInstrument() {
  goToLatestSol();
  update();
}

function goToLatestSol() {
  // Set sol to the last one
  var sol_sel = document.getElementById("sol");
  var inst_dropdown = document.getElementById("instrument");
  var avail_sols = avail[inst_dropdown.value]
  cur_sol = sol_sel.value = 
    avail_sols[avail_sols.length - 1];
  cur_img = 0;
}
</script>
</head>
<body margin="0" padding="0" onload="initPage();">
	<table width="100%" height="100%" margin="0" padding="0" cellpadding="0"><tbody>
		<tr height="*">
			<td width="50%" id="L_td" align="center">
				<img id="L_img" width="1" height="1" src="" />
			</td>
			<td width="50%" id="R_td" align="center">
				<img id="R_img" width="1" height="1" src="" />
			</td>
		</tr>
		<tr height="50">
			<td colspan="2" align="center">
				<table style="border:1px solid black;">
					<tr>
            <td>Sol</td>
						<td>Instrument</td>
						<td>Image</td>
						<td></td>
					</tr>
					<tr>
						<td><input type="text" id="sol" value="1100"/></td>
						<td>
							<select id="instrument" onchange="switchInstrument()">
							</select>
						</td>
						<td>
              <input type="text" id="image_num" value="0" size="4"/>
						</td>
						<td>
							<input type="checkbox" label="invert" id="invert" checked onchange="update();">invert</input>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</tbody></table>
  <input type="button" value="next sol" onClick="gotoNextSol()" />
  <input type="button" value="prev sol" onClick="gotoPrevSol()" />
  <input type="button" value="next img" onClick="gotoNextImage()" />
  <input type="button" value="prev img" onClick="gotoPrevImage()" />
</body>
</html>